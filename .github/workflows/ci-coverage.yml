name: CI - Coverage & History

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Test + coverage (pkgs estáveis)
        run: |
          go test ./internal/handlers ./tests/integration ./tests/smoke -coverprofile coverage.out -count=1
          go tool cover -func  coverage.out > coverage_func.txt
          go tool cover -html  coverage.out > coverage.html

      - name: Atualizar histórico (CSV/MD/badge)
        shell: pwsh
        run: |
          if (Test-Path "tools/update-coverage-history.ps1") {
            pwsh -NoProfile -ExecutionPolicy Bypass -File tools/update-coverage-history.ps1
          }

      - name: Commit histórico (main)
        if: github.ref == 'refs/heads/main' && !cancelled()
        shell: pwsh
        run: |
          $changed = git status --porcelain
          if ($changed -match 'docs/coverage_history\.csv' -or
              $changed -match 'docs/coverage_history\.md' -or
              $changed -match 'docs/badges/coverage\.svg') {
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add docs/coverage_history.csv docs/coverage_history.md docs/badges/coverage.svg
            git commit -m "docs(coverage): update history & badge [skip ci]" || echo "no changes"
            git push
          }

      - name: Upload artifact (coverage.html)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: coverage.html
